var ur1 = require('url');
//创建socket连接
function createConnection(url, headers, callback) {

        var WebSocketClient = require('websocket').client;
        var client = new WebSocketClient();

        if(ur1.parse(url).path === '/v3/base/userauth')
        {
            client.connect(url, null, null, headers);
            client.on('connectFailed', function (error) {
                //console.log('Connect Error: ' + error.toString());
                setTimeout(function () {
                    client.connect(url, null, null, headers);
                }, 100);
            });

        }else{
            client.connect(url, null, null, headers);
            client.on('connectFailed', function (error) {
                console.log('Connect Error: ' + error.toString());
            });
        }

        client.on('connect', function (connection) {

            callback(connection);

            console.log('WebSocket Client Connected');

            connection.on('error', function (error) {

                console.log("Connection Error: " + error.toString());

            });

            connection.on('close', function () {

                console.log('echo-protocol Connection Closed');

            });
        });
};
//发送数据
function sendMsg(connection, jsonData, callback) {

    if (connection) {

        if (jsonData === "lvzhouhost") {
            connection.sendUTF(jsonData);
        } else {
            connection.sendUTF(JSON.stringify(jsonData));
        }
    } else {

        console.error('myConnection is undefined...');
    }
    callback();
}

function recvMsg(connection, callback) {
    connection.on('message', function (message) {

        if (message.type === 'utf8') {
            callback(message.utf8Data);
        }
    });
}
exports.recvMsg = recvMsg;
exports.sendMsg = sendMsg;
exports.createConnection = createConnection;